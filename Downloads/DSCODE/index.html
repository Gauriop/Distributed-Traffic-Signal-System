<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Distributed Traffic Signal System Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .header {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            padding: 20px;
            text-align: center;
            border-bottom: 2px solid rgba(255, 255, 255, 0.2);
            margin-bottom: 30px;
        }

        .header h1 {
            color: white;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            margin-bottom: 10px;
        }

        .header p {
            color: rgba(255, 255, 255, 0.9);
            font-size: 1.2em;
        }

        .dashboard {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 25px;
            padding: 0 20px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .panel {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .panel:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
        }

        .panel h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.5em;
            border-bottom: 3px solid #3498db;
            padding-bottom: 10px;
        }

        .intersection {
            display: grid;
            grid-template-columns: 1fr 100px 1fr;
            grid-template-rows: 1fr 100px 1fr;
            gap: 10px;
            margin: 20px 0;
            height: 300px;
        }

        .signal {
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
            transition: all 0.3s ease;
            position: relative;
        }

        .signal.green {
            background: linear-gradient(45deg, #27ae60, #2ecc71);
            border-color: #27ae60;
            box-shadow: 0 0 20px rgba(39, 174, 96, 0.5);
        }

        .signal.red {
            background: linear-gradient(45deg, #c0392b, #e74c3c);
            border-color: #c0392b;
        }

        .signal.yellow {
            background: linear-gradient(45deg, #f39c12, #f1c40f);
            border-color: #f39c12;
        }

        .signal::before {
            content: attr(data-label);
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 12px;
            color: #666;
            font-weight: normal;
        }

        .intersection-center {
            grid-column: 2;
            grid-row: 2;
            background: linear-gradient(45deg, #34495e, #2c3e50);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 14px;
            text-align: center;
        }

        .pedestrian-panel {
            margin-top: 20px;
            padding: 15px;
            background: rgba(52, 73, 94, 0.1);
            border-radius: 10px;
            border-left: 4px solid #e67e22;
        }

        .pedestrian-signals {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-top: 10px;
        }

        .ped-signal {
            padding: 10px;
            text-align: center;
            border-radius: 8px;
            font-weight: bold;
            color: white;
        }

        .ped-signal.green {
            background: linear-gradient(45deg, #27ae60, #2ecc71);
        }

        .ped-signal.red {
            background: linear-gradient(45deg, #c0392b, #e74c3c);
        }

        .control-button {
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 12px 20px;
            margin: 5px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
        }

        .control-button:hover {
            background: linear-gradient(45deg, #2980b9, #21618c);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(52, 152, 219, 0.4);
        }

        .vip-button {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
        }

        .vip-button:hover {
            background: linear-gradient(45deg, #c0392b, #a93226);
            box-shadow: 0 6px 20px rgba(231, 76, 60, 0.4);
        }

        .load-test-button {
            background: linear-gradient(45deg, #9b59b6, #8e44ad);
            box-shadow: 0 4px 15px rgba(155, 89, 182, 0.3);
        }

        .load-test-button:hover {
            background: linear-gradient(45deg, #8e44ad, #7d3c98);
            box-shadow: 0 6px 20px rgba(155, 89, 182, 0.4);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 15px;
        }

        .stat-item {
            background: rgba(52, 152, 219, 0.1);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border-left: 4px solid #3498db;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #2c3e50;
            display: block;
        }

        .stat-label {
            color: #7f8c8d;
            font-size: 0.9em;
            margin-top: 5px;
        }

        .log-area {
            height: 200px;
            overflow-y: auto;
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.4;
            margin-top: 15px;
        }

        .log-area::-webkit-scrollbar {
            width: 8px;
        }

        .log-area::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 4px;
        }

        .log-area::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 4px;
        }

        .server-status {
            display: flex;
            justify-content: space-between;
            margin: 15px 0;
        }

        .server-indicator {
            padding: 10px 15px;
            border-radius: 20px;
            font-weight: bold;
            text-align: center;
            flex: 1;
            margin: 0 5px;
        }

        .server-primary {
            background: linear-gradient(45deg, #27ae60, #2ecc71);
            color: white;
        }

        .server-clone {
            background: linear-gradient(45deg, #f39c12, #f1c40f);
            color: white;
        }

        .server-load-balancer {
            background: linear-gradient(45deg, #9b59b6, #8e44ad);
            color: white;
        }

        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            border-radius: 20px;
            font-weight: bold;
            color: white;
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .connected {
            background: linear-gradient(45deg, #27ae60, #2ecc71);
        }

        .disconnected {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
        }

        .time-sync {
            background: rgba(52, 73, 94, 0.1);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            margin: 15px 0;
            border: 2px solid #3498db;
        }

        .sync-time {
            font-size: 1.5em;
            font-weight: bold;
            color: #2c3e50;
            font-family: 'Courier New', monospace;
        }

        @media (max-width: 1200px) {
            .dashboard {
                grid-template-columns: 1fr 1fr;
            }
        }

        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .intersection {
                height: 250px;
            }
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 20px rgba(39, 174, 96, 0.5); }
            50% { box-shadow: 0 0 30px rgba(39, 174, 96, 0.8); }
            100% { box-shadow: 0 0 20px rgba(39, 174, 96, 0.5); }
        }

        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        .message {
            padding: 10px 15px;
            margin: 10px 0;
            border-radius: 8px;
            font-weight: bold;
        }

        .message.success {
            background: rgba(39, 174, 96, 0.1);
            border-left: 4px solid #27ae60;
            color: #27ae60;
        }

        .message.error {
            background: rgba(231, 76, 60, 0.1);
            border-left: 4px solid #e74c3c;
            color: #e74c3c;
        }

        .message.vip {
            background: rgba(155, 89, 182, 0.1);
            border-left: 4px solid #9b59b6;
            color: #9b59b6;
        }
    </style>
</head>
<body>
    <div class="connection-status" id="connectionStatus">
        🔌 Connecting...
    </div>

    <div class="header">
        <h1>🚦 Distributed Traffic Signal System</h1>
        <p>Load Balanced • VIP Priority • Real-time Monitoring</p>
    </div>

    <div class="dashboard">
        <!-- Signal Control Panel -->
        <div class="panel">
            <h2>🚦 Signal Control</h2>
            
            <div class="intersection">
                <!-- Top Signal (T2) -->
                <div class="signal red" data-label="Signal 2" id="signal-2" style="grid-column: 2; grid-row: 1;">
                    T2<br>RED
                </div>
                
                <!-- Left Signal (T3) -->
                <div class="signal red" data-label="Signal 3" id="signal-3" style="grid-column: 1; grid-row: 2;">
                    T3<br>RED
                </div>
                
                <!-- Center -->
                <div class="intersection-center">
                    INTERSECTION<br>CONTROL
                </div>
                
                <!-- Right Signal (T1) -->
                <div class="signal green pulse" data-label="Signal 1" id="signal-1" style="grid-column: 3; grid-row: 2;">
                    T1<br>GREEN
                </div>
                
                <!-- Bottom Signal (T4) -->
                <div class="signal red" data-label="Signal 4" id="signal-4" style="grid-column: 2; grid-row: 3;">
                    T4<br>RED
                </div>
            </div>

            <div style="text-align: center; margin-top: 20px;">
                <button class="control-button" onclick="requestSignalChange(1)">Signal 1</button>
                <button class="control-button" onclick="requestSignalChange(2)">Signal 2</button>
                <button class="control-button" onclick="requestSignalChange(3)">Signal 3</button>
                <button class="control-button" onclick="requestSignalChange(4)">Signal 4</button>
            </div>

            <div class="pedestrian-panel">
                <h3>🚶‍♂️ Pedestrian Crossings</h3>
                <div class="pedestrian-signals">
                    <div class="ped-signal red" id="ped-1">P1<br>RED</div>
                    <div class="ped-signal green" id="ped-2">P2<br>GREEN</div>
                    <div class="ped-signal green" id="ped-3">P3<br>GREEN</div>
                    <div class="ped-signal green" id="ped-4">P4<br>GREEN</div>
                </div>
            </div>
        </div>

        <!-- VIP Control Panel -->
        <div class="panel">
            <h2>🚨 VIP Emergency Control</h2>
            
            <div style="text-align: center; margin: 20px 0;">
                <div style="margin-bottom: 15px;">
                    <strong>Emergency Vehicle Routes</strong>
                </div>
                <button class="control-button vip-button" onclick="createVIPRequest(1)">🚑 VIP Route 1</button>
                <button class="control-button vip-button" onclick="createVIPRequest(2)">🚑 VIP Route 2</button>
                <button class="control-button vip-button" onclick="createVIPRequest(3)">🚑 VIP Route 3</button>
                <button class="control-button vip-button" onclick="createVIPRequest(4)">🚑 VIP Route 4</button>
            </div>

            <div class="time-sync">
                <div>🕐 Synchronized Time</div>
                <div class="sync-time" id="syncTime">--:--:--</div>
            </div>

            <div style="text-align: center; margin-top: 20px;">
                <button class="control-button load-test-button" onclick="runLoadTest()">
                    🧪 Run Load Test (15 Requests)
                </button>
            </div>

            <div id="messageArea"></div>
        </div>

        <!-- System Status Panel -->
        <div class="panel">
            <h2>📊 System Status</h2>
            
            <div class="server-status">
                <div class="server-indicator server-primary">
                    🟦 Primary<br>Port 8000
                </div>
                <div class="server-indicator server-load-balancer">
                    ⚖️ Load Balancer<br>Port 9000
                </div>
                <div class="server-indicator server-clone">
                    🟨 Clone<br>Port 8001
                </div>
            </div>

            <div class="stats-grid">
                <div class="stat-item">
                    <span class="stat-value" id="totalRequests">0</span>
                    <span class="stat-label">Total Requests</span>
                </div>
                <div class="stat-item">
                    <span class="stat-value" id="vipRequests">0</span>
                    <span class="stat-label">VIP Requests</span>
                </div>
                <div class="stat-item">
                    <span class="stat-value" id="activeSignal">1</span>
                    <span class="stat-label">Active Signal</span>
                </div>
                <div class="stat-item">
                    <span class="stat-value" id="loadBalanced">0</span>
                    <span class="stat-label">Load Balanced</span>
                </div>
            </div>

            <div class="log-area" id="logArea">
                <div>📡 System initialized - Connecting to load balancer...</div>
                <div>⚖️ Load balancing active between primary and clone servers</div>
                <div>🔒 Ricart-Agrawala mutual exclusion protocol active</div>
                <div>👑 VIP priority system ready</div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const LOAD_BALANCER_URL = 'http://127.0.0.1:9000/';
        const UPDATE_INTERVAL = 2000; // 2 seconds

        // State management
        let systemState = {
            signals: { t1: 'green', t2: 'red', t3: 'red', t4: 'red' },
            pedestrians: { p1: 'red', p2: 'green', p3: 'green', p4: 'green' },
            activeSignal: 1,
            syncTime: '--:--:--',
            stats: {
                totalRequests: 0,
                vipRequests: 0,
                loadBalanced: 0,
                pendingRequests: 0
            },
            connected: false
        };

        // Simulated XML-RPC client (since we can't make real XML-RPC calls from browser)
        class SimulatedXMLRPCClient {
            constructor() {
                this.requestId = 1;
                this.mockData = {
                    signals: { t1: 'green', t2: 'red', t3: 'red', t4: 'red', p1: 'red', p2: 'green', p3: 'green', p4: 'green' },
                    activeSignal: 1,
                    syncTime: new Date().toTimeString().slice(0, 8),
                    stats: { total_requests: 0, vip_requests_processed: 0, load_balanced_requests: 0, pending_requests: 0 }
                };
            }

            async callMethod(method, params = []) {
                // Simulate network delay
                await new Promise(resolve => setTimeout(resolve, 100 + Math.random() * 200));
                
                switch (method) {
                    case 'signal_manipulator':
                        return this.handleSignalChange(params[0]);
                    case 'vip_signal_manipulator':
                        return this.handleVIPSignalChange(params[0]);
                    case 'get_signal_status':
                        return this.mockData.signals;
                    case 'get_active_signal':
                        return this.mockData.activeSignal;
                    case 'get_synchronized_time':
                        return this.mockData.syncTime;
                    case 'get_system_stats':
                        return this.mockData.stats;
                    case 'submit_vip_requests':
                        this.mockData.stats.vip_requests_processed++;
                        return true;
                    default:
                        return null;
                }
            }

            handleSignalChange(signalNum) {
                // Update mock data
                for (let i = 1; i <= 4; i++) {
                    this.mockData.signals[`t${i}`] = i === signalNum ? 'green' : 'red';
                    this.mockData.signals[`p${i}`] = i === signalNum ? 'red' : 'green';
                }
                this.mockData.activeSignal = signalNum;
                this.mockData.stats.total_requests++;
                
                // 30% chance to load balance
                if (Math.random() < 0.3) {
                    this.mockData.stats.load_balanced_requests++;
                }
                
                this.logMessage(`🚦 Signal change to ${signalNum} completed`);
                return true;
            }

            handleVIPSignalChange(signalNum) {
                this.handleSignalChange(signalNum);
                this.mockData.stats.vip_requests_processed++;
                this.logMessage(`🚨 VIP signal change to ${signalNum} completed with HIGH PRIORITY`);
                return true;
            }

            logMessage(message) {
                const logArea = document.getElementById('logArea');
                const timestamp = new Date().toTimeString().slice(0, 8);
                const logEntry = document.createElement('div');
                logEntry.textContent = `[${timestamp}] ${message}`;
                logArea.appendChild(logEntry);
                logArea.scrollTop = logArea.scrollHeight;
            }
        }

        // Initialize client
        const client = new SimulatedXMLRPCClient();

        // UI Update Functions
        function updateSignalDisplay(signals, activeSignal) {
            for (let i = 1; i <= 4; i++) {
                const signalEl = document.getElementById(`signal-${i}`);
                const pedEl = document.getElementById(`ped-${i}`);
                const signalStatus = signals[`t${i}`];
                const pedStatus = signals[`p${i}`];
                
                // Update signal
                signalEl.className = `signal ${signalStatus}`;
                signalEl.innerHTML = `T${i}<br>${signalStatus.toUpperCase()}`;
                
                // Update pedestrian
                pedEl.className = `ped-signal ${pedStatus}`;
                pedEl.innerHTML = `P${i}<br>${pedStatus.toUpperCase()}`;
                
                // Add pulse effect to active green signal
                if (i === activeSignal && signalStatus === 'green') {
                    signalEl.classList.add('pulse');
                } else {
                    signalEl.classList.remove('pulse');
                }
            }
        }

        function updateStats(stats) {
            document.getElementById('totalRequests').textContent = stats.total_requests || 0;
            document.getElementById('vipRequests').textContent = stats.vip_requests_processed || 0;
            document.getElementById('activeSignal').textContent = systemState.activeSignal;
            document.getElementById('loadBalanced').textContent = stats.load_balanced_requests || 0;
        }

        function updateConnectionStatus(connected) {
            const statusEl = document.getElementById('connectionStatus');
            if (connected) {
                statusEl.className = 'connection-status connected';
                statusEl.innerHTML = '🟢 Connected to Load Balancer';
            } else {
                statusEl.className = 'connection-status disconnected';
                statusEl.innerHTML = '🔴 Connection Lost';
            }
        }

        function showMessage(text, type = 'success') {
            const messageArea = document.getElementById('messageArea');
            const messageEl = document.createElement('div');
            messageEl.className = `message ${type}`;
            messageEl.textContent = text;
            messageArea.appendChild(messageEl);
            
            // Remove message after 5 seconds
            setTimeout(() => {
                messageEl.remove();
            }, 5000);
        }

        // Control Functions
        async function requestSignalChange(signalNum) {
            try {
                showMessage(`🚦 Requesting signal ${signalNum} change...`, 'success');
                const success = await client.callMethod('signal_manipulator', [signalNum]);
                
                if (success) {
                    systemState.activeSignal = signalNum;
                    showMessage(`✅ Signal ${signalNum} activated successfully`, 'success');
                    await updateSystemState();
                } else {
                    showMessage(`❌ Signal ${signalNum} request failed`, 'error');
                }
            } catch (error) {
                showMessage(`❌ Error: ${error.message}`, 'error');
            }
        }

        async function createVIPRequest(routeNum) {
            try {
                showMessage(`🚨 Creating VIP emergency request for route ${routeNum}...`, 'vip');
                
                // Submit VIP request
                const timestamp = Math.floor(Date.now() / 1000) - 1700000000;
                const vipData = [[routeNum, timestamp]];
                const submitSuccess = await client.callMethod('submit_vip_requests', [vipData]);
                
                if (submitSuccess) {
                    // Process VIP signal change
                    const success = await client.callMethod('vip_signal_manipulator', [routeNum]);
                    
                    if (success) {
                        systemState.activeSignal = routeNum;
                        showMessage(`🚑 VIP route ${routeNum} cleared with HIGHEST PRIORITY!`, 'vip');
                        await updateSystemState();
                    } else {
                        showMessage(`❌ VIP route ${routeNum} processing failed`, 'error');
                    }
                } else {
                    showMessage(`❌ VIP request submission failed`, 'error');
                }
            } catch (error) {
                showMessage(`❌ VIP Error: ${error.message}`, 'error');
            }
        }

        async function runLoadTest() {
            try {
                showMessage(`🧪 Starting load test with 15 simultaneous requests...`, 'success');
                const loadTestButton = document.querySelector('.load-test-button');
                loadTestButton.classList.add('loading');
                loadTestButton.textContent = '🧪 Running Load Test...';
                
                // Simulate 15 concurrent signal status requests
                const promises = [];
                for (let i = 1; i <= 15; i++) {
                    promises.push(client.callMethod('get_signal_status'));
                    promises.push(client.callMethod('get_system_stats'));
                }
                
                const startTime = Date.now();
                await Promise.all(promises);
                const duration = Date.now() - startTime;
                
                // Update stats to reflect load test
                client.mockData.stats.total_requests += 15;
                client.mockData.stats.load_balanced_requests += Math.floor(Math.random() * 8) + 3; // Simulate load balancing
                
                showMessage(`✅ Load test completed! 30 operations in ${duration}ms`, 'success');
                client.logMessage(`🧪 Load test: 15 requests completed in ${duration}ms`);
                client.logMessage(`⚖️ Load balancer distributed ${client.mockData.stats.load_balanced_requests} requests to clone server`);
                
                loadTestButton.classList.remove('loading');
                loadTestButton.textContent = '🧪 Run Load Test (15 Requests)';
                
                await updateSystemState();
            } catch (error) {
                showMessage(`❌ Load test error: ${error.message}`, 'error');
                document.querySelector('.load-test-button').classList.remove('loading');
                document.querySelector('.load-test-button').textContent = '🧪 Run Load Test (15 Requests)';
            }
        }

        // System State Updates
        async function updateSystemState() {
            try {
                const [signals, activeSignal, syncTime, stats] = await Promise.all([
                    client.callMethod('get_signal_status'),
                    client.callMethod('get_active_signal'),
                    client.callMethod('get_synchronized_time'),
                    client.callMethod('get_system_stats')
                ]);

                systemState.signals = signals;
                systemState.activeSignal = activeSignal;
                systemState.syncTime = syncTime;
                systemState.stats = stats;
                systemState.connected = true;

                updateSignalDisplay(signals, activeSignal);
                updateStats(stats);
                document.getElementById('syncTime').textContent = syncTime;
                updateConnectionStatus(true);
                
            } catch (error) {
                systemState.connected = false;
                updateConnectionStatus(false);
                console.error('Failed to update system state:', error);
            }
        }

        // Initialize and start periodic updates
        async function initialize() {
            client.logMessage('🚀 Dashboard initialized');
            client.logMessage('🔗 Connecting to load balancer on port 9000...');
            client.logMessage('⚖️ Load balancing between primary (8000) and clone (8001)');
            client.logMessage('🔒 Ricart-Agrawala mutual exclusion active');
            
            await updateSystemState();
            
            // Start periodic updates
            setInterval(async () => {
                await updateSystemState();
            }, UPDATE_INTERVAL);
            
            // Update clock every second
            setInterval(() => {
                if (systemState.connected) {
                    const now = new Date();
                    client.mockData.syncTime = now.toTimeString().slice(0, 8);
                }
            }, 1000);
        }

        // Real XML-RPC Integration Helper (for actual deployment)
        class XMLRPCProxy {
            constructor(url) {
                this.url = url;
            }

            // This would be the actual XML-RPC implementation
            // For now, it falls back to simulation
            async call(method, params = []) {
                try {
                    // In a real deployment, you would use a library like xmlrpc
                    // or implement HTTP POST requests with XML-RPC format
                    
                    // Example of what the actual implementation might look like:
                    /*
                    const xmlrpc = require('xmlrpc');
                    const client = xmlrpc.createClient(this.url);
                    return new Promise((resolve, reject) => {
                        client.methodCall(method, params, (error, value) => {
                            if (error) reject(error);
                            else resolve(value);
                        });
                    });
                    */
                    
                    // For browser compatibility, fall back to simulation
                    return await client.callMethod(method, params);
                } catch (error) {
                    console.warn('XML-RPC call failed, using simulation:', error);
                    return await client.callMethod(method, params);
                }
            }
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', (event) => {
            if (event.ctrlKey || event.metaKey) return; // Ignore system shortcuts
            
            switch (event.key) {
                case '1':
                    requestSignalChange(1);
                    break;
                case '2':
                    requestSignalChange(2);
                    break;
                case '3':
                    requestSignalChange(3);
                    break;
                case '4':
                    requestSignalChange(4);
                    break;
                case 'v':
                case 'V':
                    // Show VIP modal or cycle through VIP routes
                    const vipRoute = Math.floor(Math.random() * 4) + 1;
                    createVIPRequest(vipRoute);
                    break;
                case 'l':
                case 'L':
                    runLoadTest();
                    break;
            }
        });

        // Add tooltip functionality
        function addTooltips() {
            const tooltipElements = [
                { selector: '.control-button:not(.vip-button):not(.load-test-button)', text: 'Request normal signal change' },
                { selector: '.vip-button', text: 'Emergency VIP request - highest priority' },
                { selector: '.load-test-button', text: 'Test load balancing with 15 concurrent requests' },
                { selector: '.server-indicator', text: 'Server status and capacity' }
            ];

            tooltipElements.forEach(({ selector, text }) => {
                document.querySelectorAll(selector).forEach(el => {
                    el.title = text;
                });
            });
        }

        // Export functionality for integration
        window.TrafficSignalDashboard = {
            initialize,
            requestSignalChange,
            createVIPRequest,
            runLoadTest,
            updateSystemState,
            XMLRPCProxy
        };

        // Start the application
        document.addEventListener('DOMContentLoaded', () => {
            initialize();
            addTooltips();
            
            // Add keyboard shortcut hints
            client.logMessage('⌨️ Keyboard shortcuts: 1-4 (signals), V (VIP), L (load test)');
        });

        // Handle browser compatibility and errors
        window.addEventListener('error', (event) => {
            client.logMessage(`❌ Error: ${event.error?.message || 'Unknown error'}`);
        });

        window.addEventListener('unhandledrejection', (event) => {
            client.logMessage(`❌ Promise rejected: ${event.reason}`);
        });
    </script>
</body>
</html>